#!groovyâ€‹

node('Linux') {
    stage('Clone sources') {
        checkout scm
    }

    /* def image = null
    stage('Build docker image') {
        image = docker.build('meta-conan-validate', '-f .ci/Dockerfile .')
    }

    stage('Validate Yocto layer') {
        image.inside {
            sh '''
                whoami
                WORKSPACE=${PWD}
                git clone --depth 1 git://git.yoctoproject.org/poky -b dunfell /tmp/poky
                git clone --depth 1 git://git.openembedded.org/meta-openembedded.git -b dunfell /tmp/meta-openembedded
                cd /tmp/poky/
                . /tmp/poky/oe-init-build-env
                touch conf/sanity.conf
                cd /tmp/meta-openembedded
                yocto-check-layer -d --dependency meta-oe meta-python --with-software-layer-signature-check ${WORKSPACE}
            '''
        }
    } */

    def yocto_builder_image = null
    stage('Build yocto-builder docker image') {
        yocto_builder_image = docker.build("conan-io/yocto-builder:${env.BUILD_ID}", '-f .ci/yocto/Dockerfile .')
    }

    stage('Build yocto image') {
        yocto_builder_image.inside {
            sh 'su - conan'
            sh 'git clone --branch kirkstone --depth 1 git://git.yoctoproject.org/poky'
            sh 'mkdir poky/conf && touch poky/conf/sanity.conf'
            sh '''#!/bin/bash
            source poky/oe-init-build-env
            bitbake -k core-image-minimal
            '''
        }
    }
}
